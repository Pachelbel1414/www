<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quads — Tabs App</title>
  <style>
    :root{ --bg:#fafafa; --ink:#111; --muted:#6b7280; --brand:#2563eb; --gold:#b45309; --purple:#6d28d9; --border:#e5e7eb; --card:#fff; --card-w: 100px; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .app{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0 0 8px 0;font-size:20px}
    .status{color:var(--muted);font-size:13px;margin-bottom:8px}
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);margin-bottom:12px}
    .tab-btn{appearance:none;border:0;background:transparent;padding:10px 14px;border-bottom:2px solid transparent;font-weight:700;color:var(--muted);cursor:pointer;border-radius:8px 8px 0 0}
    .tab-btn[aria-selected="true"]{color:var(--brand);border-color:var(--brand);background:#fff}
    .tab-panel{display:none}
    .tab-panel[aria-hidden="false"]{display:block}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0}
    .pill{display:inline-flex;gap:8px;align-items:center;font-weight:700;background:#eef2ff;border:1px solid #e0e7ff;border-radius:999px;padding:6px 10px}
    label{font-weight:600}
    select,input[type=number]{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#fff}
    button{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer;font-weight:700}
    button.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .bin-wrap{display:flex;gap:16px;flex-wrap:wrap}
    .bin{flex:1;min-width:280px}
    .grid{display:grid;gap:8px}
    .grid.c4x8{grid-template-columns:repeat(4, var(--card-w)); justify-content:center}
    .grid.c4x4{grid-template-columns:repeat(4, var(--card-w)); justify-content:center}
    .grid.single4x4{grid-template-columns:repeat(4, var(--card-w)); justify-content:center}
    .cell{border-radius:10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;height:60px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;cursor:pointer;width:var(--card-w)}
    .front{display:none}
    .back{display:flex;align-items:center;justify-content:center;flex:1;color:#9ca3af}
    .card.faceup .front{display:flex}
    .card.faceup .back{display:none}
    .labels{display:none}
    .pic {
  display: grid;
  grid-auto-flow: column;     /* lay items left→right */
  grid-auto-columns: auto;    /* one auto-width track per shape */
  justify-content: center;    /* center the whole row of shapes */
  justify-items: center;      /* center each shape in its track */
  gap: 4px;
  align-items: center;
  width: 100%;
.front { display: flex; justify-content: center; width: 100%; }
}
    svg.shape{width:16px;height:16px}
    /* Basis/Layout */
    .pile{display:flex;flex-wrap:wrap;gap:8px;min-height:124px;padding:8px;border:1px dashed var(--border);border-radius:12px;background:#fff}
    .bin-container{display:flex;gap:16px;align-items:flex-start;margin-top:10px}
    .bin-side{flex:1;min-width:280px}
    .bin-divider{width:1px;background:var(--border)}
    .badge{border:2px dashed #e5e7eb;min-height:60px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#fff}
    .badge.basis{border-color:#c7d2fe;background:#eef2ff}
    .drop-ok{outline:3px solid var(--brand);outline-offset:2px}
    .backcard{background:var(--card);border:1px solid var(--border);border-radius:10px;height:60px;display:flex;align-items:center;justify-content:center;color:#9ca3af;width:var(--card-w)}
    /* Suggested highlight */
    .suggested{ box-shadow: inset 0 0 0 3px var(--brand); }
    /* Phi map */
    .phiCell{cursor:pointer}
    .phiA{outline:2px solid rgba(217,119,6,0.35); outline-offset:2px; box-shadow:0 0 0 2px rgba(217,119,6,0.10)}
    .phiB{outline:2px solid rgba(124,58,237,0.35); outline-offset:2px; box-shadow:0 0 0 2px rgba(124,58,237,0.10)}
    .phiSelectedA{outline:3px solid #b45309 !important; box-shadow:0 0 10px 4px rgba(180,83,9,0.45) !important; border-radius:12px}
    .phiSelectedB{outline:3px solid #6d28d9 !important; box-shadow:0 0 10px 4px rgba(109,40,217,0.45) !important; border-radius:12px}
    .a-shadow{outline:3px solid rgba(217,119,6,0.7); outline-offset:2px; box-shadow:0 0 0 3px rgba(217,119,6,0.18)}
 /* 50% size for cards that are in the Selected Pile */
.pile .card {
  width: calc(var(--card-w) * 0.5);   /* 100px → 50px by default */
  height: 30px;                        /* 60px → 30px */
}

/* If placeholders/back faces ever appear in the pile, size them too */
.pile .backcard {
  width: calc(var(--card-w) * 0.5);
  height: 30px;
}

/* Scale down the shapes inside the card for better fit */
.pile svg.shape {
  width: 10px;   /* 16px → 12px */
  height: 10px;
}

/* Optional: slightly tighter spacing between shapes in the pile */
.pile .pic {
  gap: 1px;
}
 




/* --- Single ring around the Random-N controls --- */
@media (max-width: 520px){
  }

/* --- Single ring around the Basis/Layout controls --- */
@media (max-width: 520px){
  }
</style>
</head>
<body>
  <div class="app">
    <h1>Quads — New App (Tabs)</h1>
    <div id="status" class="status">(initializing…)</div>

    <div role="tablist" aria-label="Quads tabs" class="tabs">
      <button class="tab-btn" role="tab" id="tab-select" aria-controls="panel-select" aria-selected="true">Select Cards</button>
      <button class="tab-btn" role="tab" id="tab-layout" aria-controls="panel-layout" aria-selected="false">Basis / Layout</button>
      <button class="tab-btn" role="tab" id="tab-phi" aria-controls="panel-phi" aria-selected="false">Phi Map</button>
    </div>

    <!-- Select Cards Panel -->
    <section id="panel-select" class="tab-panel" role="tabpanel" aria-labelledby="tab-select" aria-hidden="false">
      <div class="row">
        <span id="deckPill" class="pill"><label for="deckSize">Deck:</label>
        <select id="deckSize">
          <option value="64" selected>64</option>
          <option value="32">32</option>
          <option value="16">16</option>
        </select></span>
        <span class="pill"><span class="muted">Face-up</span> <strong id="upCount">0 / 64</strong></span>
        <span class="pill"><span class="muted">Quads</span> <strong id="selectQuadCount">0</strong></span>
      </div>
      <div class="row">
        
        
        <span id="randomGroup" class="pill"><label for="nCount">Random N</label>
        <input id="nCount" type="number" value="12" min="1" max="64" />
        <button id="randomN">Apply</button></span>
        <span id="revealHidePill" class="pill"><button id="revealAll" class="primary">Reveal all</button><button id="hideAll">Hide all</button></span>
      </div>

      <div id="bins" class="bin-wrap">
        <div class="bin" id="bin-left">
          <h3 id="leftLabel">Left</h3>
          <div id="grid-left" class="grid c4x8"></div>
        </div>
        <div class="bin" id="bin-right">
          <h3 id="rightLabel">Right</h3>
          <div id="grid-right" class="grid c4x8"></div>
        </div>
      </div>
    </section>

    <!-- Basis/Layout -->
    <section id="panel-layout" class="tab-panel" role="tabpanel" aria-labelledby="tab-layout" aria-hidden="true">
      <div class="row"><span id="basisGroup" class="pill"><button id="basisStartNew" class="primary">Choose new basis</button><button id="basisSuggest0">Suggest 0</button><button id="basisSuggestNext">Suggest next</button>
          <div class="basis-msg"><span id="basisSuggest0Msg" class="muted"></span><span id="basisSuggestNextMsg" class="muted"></span><span id="basisResetMsg" class="muted"></span></div>
        </span>
        <button id="basisResetLayout">Return to Standard Layout</button>
        
         <span class="pill"><span class="muted">Face-up</span> <strong id="basisUpCount">0</strong></span>
        <span class="pill"><span class="muted">Quads</span> <strong id="basisQuadCount">0</strong></span>
        
        
        
         
        
        </div>

      <h3>Selected Pile</h3>
      <div id="basisPile" class="pile"></div>

      <h3 id="basisGridTitle">Grid</h3>
      <div class="bin-container">
        <div class="bin-side"><div id="basis-grid-left" class="grid"></div></div>
        <div class="bin-divider"></div>
        <div class="bin-side"><div id="basis-grid-right" class="grid"></div></div>
      </div>
    </section>

    <!-- Phi Map -->
    <section id="panel-phi" class="tab-panel" role="tabpanel" aria-labelledby="tab-phi" aria-hidden="true">
      <div class="row"><span class="pill"><span class="muted">Partition</span>
          <select id="phiPartition">
            <option value="lr" selected>Left / Right</option>
            <option value="tb">Top / Bottom</option>
            <option value="rowsdbl">Double Rows</option>
            <option value="colsdbl">Double Cols</option>
            <option value="rowsAlt">Alternating Rows</option>
            <option value="colsAlt">Alternating Cols</option>
          </select>
        </span>
        <span id="phiActionPill" class="pill"><button id="phiStart" class="primary">Select Phi Map</button><button id="phiUndo">Undo φ-map</button><button id="phiApply">Apply</button><button id="phiClearSel">Clear</button></span>
        
        
        
        
        <span class="pill"><span class="muted">Quads before</span> <strong id="phiQuadBefore">0</strong></span>
        <span class="pill"><span class="muted">Quads after</span> <strong id="phiQuadAfter"></strong></span></div>
      <div id="phiInfo" class="muted" style="margin:.25rem 0;">Pick a face-up card for <b>b</b> from a purple (B) zone, then a face-down card for <b>a</b> from a gold (A) zone.</div>

      <h3 id="phiGridTitle">Phi Map Grid</h3>
      <div class="bin-container">
        <div class="bin-side"><div id="phi-grid-left" class="grid"></div></div>
        <div class="bin-divider"></div>
        <div class="bin-side"><div id="phi-grid-right" class="grid"></div></div>
      </div>
    </section>
  </div>

<script>
// ---------- Utilities ----------
function byId(id){ return document.getElementById(id); }
function pad6(n){ var s=n.toString(2); while(s.length<6) s='0'+s; return s; }
function decodeBits(bits){
  var color={"00":"#ef4444","01":"#10b981","10":"#f59e0b","11":"#3b82f6"}[bits.slice(0,2)];
  var shape={"00":"circle","01":"triangle","10":"square","11":"heart"}[bits.slice(2,4)];
  var count={"00":1,"01":2,"10":3,"11":4}[bits.slice(4,6)];
  return {color:color,shape:shape,count:count};
}
function shapeSVG(shape,color){
  var svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('class','shape'); svg.setAttribute('viewBox','0 0 32 32');
  var el;
  if(shape==='circle'){ el=document.createElementNS('http://www.w3.org/2000/svg','circle'); el.setAttribute('cx','16'); el.setAttribute('cy','16'); el.setAttribute('r','12'); }
  else if(shape==='triangle'){ el=document.createElementNS('http://www.w3.org/2000/svg','polygon'); el.setAttribute('points','16,4 28,28 4,28'); }
  else if(shape==='square'){ el=document.createElementNS('http://www.w3.org/2000/svg','rect'); el.setAttribute('x','6'); el.setAttribute('y','6'); el.setAttribute('width','20'); el.setAttribute('height','20'); }
  else { el=document.createElementNS('http://www.w3.org/2000/svg','path'); el.setAttribute('d','M16 29s-13-7.4-13-17c0-4.4 3.6-8 8-8 3.1 0 5.9 1.8 7 4.4C19.1 5.8 21.9 4 25 4c4.4 0 8 3.6 8 8 0 9.6-13 17-13 17z'); }
  el.setAttribute('fill',color); svg.appendChild(el); return svg;
}

// ---------- Global state ----------
var DECK=64;
var statusEl = byId('status');
var deckSel = byId('deckSize');
var upCountEl = byId('upCount');
var gridL = byId('grid-left');
var gridR = byId('grid-right');
var leftLabel = byId('leftLabel');
var rightLabel = byId('rightLabel');

function allCards(){ return Array.prototype.slice.call(document.querySelectorAll('#grid-left .card, #grid-right .card')); }
function getCardEl(n){ return document.querySelector('#grid-left .card[data-index="'+n+'"], #grid-right .card[data-index="'+n+'"]'); }
function isFaceUp(n){ var el=getCardEl(n); return !!(el && el.classList.contains('faceup')); }
function setFaceUp(n, up){ var el=getCardEl(n); if(!el) return; if(up){ el.classList.add('faceup'); } else { el.classList.remove('faceup'); } }

function getFaceUpCount(){ var up=0, cards=allCards(); for(var i=0;i<cards.length;i++){ if(cards[i].classList.contains('faceup')) up++; } return up; }
function getSelectedIndices(){ var out=[]; var cards=allCards(); for(var i=0;i<cards.length;i++){ var c=cards[i]; if(c.classList.contains('faceup')){ var idx=+c.closest('.cell').querySelector('.card').dataset.index; out.push(idx); } } out.sort(function(a,b){return a-b;}); return out; }
function computeQuadsBasic(indices){
  var seen={}, uniq=[]; for(var i=0;i<indices.length;i++){ var v=indices[i]; if(!seen[v]){ seen[v]=1; uniq.push(v); } }
  uniq.sort(function(a,b){return a-b;});
  var present={}; for(var u=0; u<uniq.length; u++) present[uniq[u]] = 1; // FIXED: proper loop condition
  var cnt=0;
  for(var i1=0;i1<uniq.length;i1++){
    for(var j1=i1+1;j1<uniq.length;j1++){
      for(var k1=j1+1;k1<uniq.length;k1++){
        var a=uniq[i1], b=uniq[j1], c=uniq[k1], d=a^b^c;
        if(d>c && d<DECK && present[d]) cnt++;
      }
    }
  }
  return cnt;
}

function updateUpCount(){
  var up=getFaceUpCount();
  upCountEl.textContent = up + ' / ' + DECK;
  var qEl = byId('selectQuadCount'); if(qEl){ qEl.textContent = String(computeQuadsBasic(getSelectedIndices())); }
}
function makeFront(n){
  var bits=pad6(n), d=decodeBits(bits);
  var front=document.createElement('div'); front.className='front';
  var pic=document.createElement('div'); pic.className='pic';
  for(var i=0;i<d.count;i++) pic.appendChild(shapeSVG(d.shape,d.color));
  var labels=document.createElement('div'); labels.className='labels';
  front.appendChild(pic); front.appendChild(labels);
  return front;
}
function makeCard(n){
  var cell=document.createElement('div'); cell.className='cell';
  var card=document.createElement('div'); card.className='card'; card.dataset.index=n;
  var front=makeFront(n);
  var back=document.createElement('div'); back.className='back'; back.textContent='●';
  card.appendChild(front); card.appendChild(back);
  card.addEventListener('click', function(){ card.classList.toggle('faceup'); updateUpCount(); updateDownstreamCounts(); });
  cell.appendChild(card); return cell;
}
function buildDeck(){
  gridL.innerHTML=''; gridR.innerHTML='';
  var nCount = byId('nCount'); if(nCount){ nCount.max = String(DECK); if(+nCount.value>DECK) nCount.value=String(DECK); }
  if(DECK===64){ gridL.className='grid c4x8'; gridR.className='grid c4x8'; for(var i=0;i<32;i++) gridL.appendChild(makeCard(i)); for(var j=32;j<64;j++) gridR.appendChild(makeCard(j)); }
  else if(DECK===32){ gridL.className='grid c4x4'; gridR.className='grid c4x4'; for(var a=0;a<16;a++) gridL.appendChild(makeCard(a)); for(var b=16;b<32;b++) gridR.appendChild(makeCard(b)); }
  else { gridL.className='grid single4x4'; gridR.className='grid single4x4'; gridR.innerHTML=''; for(var c=0;c<16;c++) gridL.appendChild(makeCard(c)); }
  updateUpCount(); updateDownstreamCounts();
}

function updateDownstreamCounts(){
  var basisUp = byId('basisUpCount'); if(basisUp) basisUp.textContent = String(getFaceUpCount());
  var basisQ  = byId('basisQuadCount'); if(basisQ)  basisQ.textContent  = String(computeQuadsBasic(getSelectedIndices()));
  var phiBefore = byId('phiQuadBefore'); if(phiBefore && (typeof phi === 'undefined' || !phi || !phi.lastPhi)) phiBefore.textContent = String(computeQuadsBasic(getSelectedIndices()));
}

function wireSelectControls(){
  var reveal=byId('revealAll'), hide=byId('hideAll'), rnd=byId('randomN');
  if(reveal) reveal.addEventListener('click', function(){ var cards=allCards(); for(var i=0;i<cards.length;i++) cards[i].classList.add('faceup'); updateUpCount(); refreshIfOnLayout(); buildPhiGridIfInit(); });
  if(hide) hide.addEventListener('click', function(){ var cards=allCards(); for(var i=0;i<cards.length;i++) cards[i].classList.remove('faceup'); updateUpCount(); refreshIfOnLayout(); buildPhiGridIfInit(); });
  if(rnd) rnd.addEventListener('click', function(){ var n=parseInt(byId('nCount').value||'0',10); if(isNaN(n)||n<1) n=1; if(n>DECK) n=DECK; var picks=[]; var set={}; while(picks.length<n){ var r=Math.floor(Math.random()*DECK); if(!set[r]){ set[r]=1; picks.push(r);} } var cards=allCards(); for(var i=0;i<cards.length;i++){ if(picks.indexOf(i)!==-1) cards[i].classList.add('faceup'); else cards[i].classList.remove('faceup'); } updateUpCount(); refreshIfOnLayout(); buildPhiGridIfInit(); });
  deckSel.addEventListener('change', function(e){ DECK=parseInt(e.target.value,10); buildDeck(); basis.mappingComplete=false; basis.locked=false; basis.pos2val=null; basis.lockedPos2val=null; refreshIfOnLayout(); buildPhiGridIfInit(); updatePartitionDisables(); });
}

// Tabs
var tabs=[{btn:byId('tab-select'),panel:byId('panel-select')},{btn:byId('tab-layout'),panel:byId('panel-layout')},{btn:byId('tab-phi'),panel:byId('panel-phi')}];
for(var t=0;t<tabs.length;t++){
  (function(T){ T.btn.addEventListener('click', function(){ for(var k=0;k<tabs.length;k++){ var B=tabs[k]; B.btn.setAttribute('aria-selected', String(B===T)); B.panel.setAttribute('aria-hidden', String(B.panel!==T.panel)); }
    if(T.btn.id==='tab-layout'){ if(!basis.pile) initBasisTab(); else refreshBasisEverything(); }
    if(T.btn.id==='tab-phi'){ if(!phi.initialized) initPhiTab(); else buildPhiGrid(); }
  }); })(tabs[t]);
}

// Boot
function init(){ try{ if(!deckSel) throw new Error('Missing Select tab markup.'); DECK=parseInt(deckSel.value,10); buildDeck(); wireSelectControls(); statusEl.textContent='Ready'; } catch(err){ statusEl.textContent='Init error: '+err.message; console.error(err); } }
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }

// ===== Basis/Layout =====
var basis={ pile:null, gridL:null, gridR:null, suggestedIndex:null, pos2val:null, val2pos:null, mappingComplete:false, locked:false, lockedPos2val:null, editing:false };
function refreshIfOnLayout(){ if(tabs[1].panel.getAttribute('aria-hidden')==='false'){ refreshBasisEverything(); } }
function getSelectedIndicesUnique(){ var arr=getSelectedIndices(); var out=[], seen={}; for(var i=0;i<arr.length;i++){ if(!seen[arr[i]]){ seen[arr[i]]=1; out.push(arr[i]); } } return out; }
function makeBasisCard(n){ var d=document.createElement('div'); d.className='card faceup'; d.dataset.index=n; d.appendChild(makeFront(n)); d.setAttribute('draggable','true'); d.addEventListener('dragstart', function(e){ e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain', String(n)); var p=d.closest('.cell'); if(p && p.hasAttribute('data-pos')){ e.dataTransfer.setData('from','grid'); e.dataTransfer.setData('fromPos', p.getAttribute('data-pos')); } else { e.dataTransfer.setData('from','pile'); } }); return d; }
function basisCellAt(pos){ var rightStart=(DECK===64?32:(DECK===32?16:Infinity)); if(pos<rightStart) return basis.gridL.children[pos]||null; if(pos>=rightStart && rightStart!==Infinity) return basis.gridR.children[pos-rightStart]||null; return null; }
function buildBasisGrid(){ if(!basis.gridL||!basis.gridR) return; var basisPos=[0,1,2,4,8,16,32].filter(function(x){return x<DECK;}); basis.gridL.innerHTML=''; basis.gridR.innerHTML=''; var divider=document.querySelector('.bin-divider');
  function makeCell(i){ var d=document.createElement('div'); d.className='cell badge'; d.setAttribute('data-pos', i); d.setAttribute('data-auto','0'); if(basisPos.indexOf(i)!==-1) d.classList.add('basis'); return d; }
  if(DECK===64){ basis.gridL.className='grid c4x8'; basis.gridR.className='grid c4x8'; for(var i=0;i<32;i++) basis.gridL.appendChild(makeCell(i)); for(var j=32;j<64;j++) basis.gridR.appendChild(makeCell(j)); divider.style.display='block'; }
  else if(DECK===32){ basis.gridL.className='grid c4x4'; basis.gridR.className='grid c4x4'; for(var a=0;a<16;a++) basis.gridL.appendChild(makeCell(a)); for(var b=16;b<32;b++) basis.gridR.appendChild(makeCell(b)); divider.style.display='block'; }
  else { basis.gridL.className='grid single4x4'; basis.gridR.className='grid single4x4'; for(var c=0;c<16;c++) basis.gridL.appendChild(makeCell(c)); divider.style.display='none'; }
  byId('basisGridTitle').textContent='Grid ('+DECK+' places)'; enableBasisDnD();
}
function refreshBasisPile(){ if(!basis.pile) return; var sel=getSelectedIndicesUnique(); basis.pile.innerHTML=''; for(var i=0;i<sel.length;i++) basis.pile.appendChild(makeBasisCard(sel[i])); byId('basisUpCount').textContent=String(sel.length); byId('basisQuadCount').textContent=String(computeQuadsBasic(sel)); }
function enableBasisDnD(){ var droppables=[0,1,2,4,8,16,32].filter(function(x){return x<DECK;}); droppables.forEach(function(pos){ var cell=basisCellAt(pos); if(!cell) return; cell.addEventListener('dragover', function(e){ e.preventDefault(); cell.classList.add('drop-ok'); }); cell.addEventListener('dragleave', function(){ cell.classList.remove('drop-ok'); }); cell.addEventListener('drop', function(e){ e.preventDefault(); cell.classList.remove('drop-ok'); var idx=parseInt(e.dataTransfer.getData('text/plain'),10); var from=e.dataTransfer.getData('from'); var fromPos=parseInt(e.dataTransfer.getData('fromPos')||'-1',10); var node=null; if(from==='pile'){ node=basis.pile.querySelector('.card[data-index="'+idx+'"]'); } else if(from==='grid'){ var src=basisCellAt(fromPos); node=src?src.querySelector('.card[data-index="'+idx+'"]'):null; if(src){ src.innerHTML=''; src.classList.add('badge'); src.setAttribute('data-pos', String(fromPos)); src.setAttribute('data-auto','0'); } } if(!node) return; cell.innerHTML=''; cell.classList.add('badge'); cell.setAttribute('data-pos', String(pos)); cell.setAttribute('data-auto','0'); cell.appendChild(node); basisAutoFill(); 
      clearSuggested();
      // Auto-lock when the pile is empty after placing the last card
setTimeout(function(){
  try{
    if(basis && basis.pile && !basis.locked){
      var hasChild = !!basis.pile.firstElementChild;
      var hasCard = !!basis.pile.querySelector('.card');
      if(!hasChild || !hasCard){ lockPositions(); }
    }
  }catch(_e){}
}, 0);
scheduleClearBasisMsgOnNextClick(); if(!basis.locked){ var anchors=[0,1,2,4,8,16,32].filter(function(x){return x<DECK;}); var allPlaced=true; for(var z=0; z<anchors.length; z++){ if(readBasisValue(anchors[z])==null){ allPlaced=false; break; } } if(allPlaced){ lockPositions(); } } }); }); basis.pile.addEventListener('dragover', function(e){ e.preventDefault(); }); basis.pile.addEventListener('drop', function(e){ e.preventDefault(); var fromPos=parseInt(e.dataTransfer.getData('fromPos')||'-1',10); if(!isNaN(fromPos)){ var src=basisCellAt(fromPos); if(src){ var c=src.querySelector('.card'); if(c){ basis.pile.appendChild(c); } src.innerHTML=''; src.classList.add('badge'); src.setAttribute('data-pos', String(fromPos)); src.setAttribute('data-auto','0'); } basisAutoFill(); clearBasisSuggestMsg(); } }); }
function readBasisValue(pos){ var c=basisCellAt(pos); if(!c) return null; var el=c.querySelector('[data-index]'); return el?+el.dataset.index:null; }
function snapshotLayoutMapping(){ var pos2=[], val2=Array(DECK); for(var p=0;p<DECK;p++){ var v=readBasisValue(p); if(v==null){ basis.mappingComplete=false; basis.pos2val=null; basis.val2pos=null; return; } pos2[p]=v; val2[v]=p; } basis.pos2val=pos2; basis.val2pos=val2; basis.mappingComplete=true; }
function makeFaceDownPlaceholder(n){ var ghost=document.createElement('div'); ghost.className='backcard'; ghost.dataset.index=n; ghost.textContent='●'; return ghost; }
function placeBasisAuto(targetPos, value){
  var cell=basisCellAt(targetPos); if(!cell) return;
  var already = cell.querySelector('.card[data-index="'+value+'"]');
  if(already){ cell.setAttribute('data-auto','1'); return; }
  var node = basis.pile ? basis.pile.querySelector('.card[data-index="'+value+'"]') : null;
  if(!node){
    var elsewhere = document.querySelector('#basis-grid-left .card[data-index="'+value+'"], #basis-grid-right .card[data-index="'+value+'"]');
    if(elsewhere){
      var fromCell = elsewhere.closest('.cell');
      if(fromCell){
        fromCell.innerHTML='';
        fromCell.classList.add('badge');
        fromCell.setAttribute('data-auto','1');
      }
      node = elsewhere;
    }
  }
  cell.innerHTML='';
  cell.classList.add('badge');
  cell.setAttribute('data-pos', String(targetPos));
  cell.setAttribute('data-auto','1');
  if(node){ cell.appendChild(node); } else { cell.appendChild(makeFaceDownPlaceholder(value)); }
}
function resetBasisCell(pos){ var cell=basisCellAt(pos); if(!cell) return; if(cell.getAttribute('data-auto')!=='1') return; var c=cell.querySelector('.card'); if(c){ basis.pile.appendChild(c); } cell.innerHTML=''; cell.classList.add('badge'); cell.setAttribute('data-pos', String(pos)); cell.setAttribute('data-auto','0'); }
function xorFromLower(mask){ var bases=[1,2,4,8,16,32].filter(function(b){return b<DECK;}); var acc=0, have=true; for(var i=0;i<bases.length;i++){ var b=bases[i]; if(mask & b){ var v=readBasisValue(b); if(v==null){ have=false; break; } acc ^= v; } } return have?acc:null; }
function popcount(x){ var c=0; while(x){ c+=x&1; x>>=1; } return c; }
function basisAutoFill(){ if(!basis.gridL||!basis.gridR) return; var v0=readBasisValue(0), v1=readBasisValue(1), v2=readBasisValue(2), v4=readBasisValue(4);
  if(v0!=null && v1!=null && v2!=null) placeBasisAuto(3, v0^v1^v2); else resetBasisCell(3);
  if(v0!=null && v1!=null && v4!=null) placeBasisAuto(5, v0^v1^v4); else resetBasisCell(5);
  if(v0!=null && v2!=null && v4!=null) placeBasisAuto(6, v0^v2^v4); else resetBasisCell(6);
  if(v1!=null && v2!=null && v4!=null) placeBasisAuto(7, v1^v2^v4); else resetBasisCell(7);
  var v8=readBasisValue(8); if(DECK>8 && v8!=null){ for(var k=1;k<=7 && 8+k<DECK;k++){ var vr=xorFromLower(k); if(vr==null){ resetBasisCell(8+k); continue; } var need=(popcount(k)%2===1 && v0!=null)? (v0 ^ vr ^ v8) : (vr ^ v8); placeBasisAuto(8+k, need); } } else { for(var p=9;p<=15 && p<DECK;p++) resetBasisCell(p); }
  var v16=readBasisValue(16); if(DECK>16 && v16!=null){ for(var k2=1;k2<=15 && 16+k2<DECK;k2++){ var vr2=xorFromLower(k2); if(vr2==null){ resetBasisCell(16+k2); continue; } var need2=(popcount(k2)%2===1 && v0!=null)? (v0 ^ vr2 ^ v16) : (vr2 ^ v16); placeBasisAuto(16+k2, need2); } } else { for(var p2=17;p2<=31 && p2<DECK;p2++) resetBasisCell(p2); }
  var v32=readBasisValue(32); if(DECK>32 && v32!=null){ for(var k3=1;k3<=31 && 32+k3<DECK;k3++){ var vr3=xorFromLower(k3); if(vr3==null){ resetBasisCell(32+k3); continue; } var need3=(popcount(k3)%2===1 && v0!=null)? (v0 ^ vr3 ^ v32) : (vr3 ^ v32); placeBasisAuto(32+k3, need3); } } else { for(var p3=33;p3<=63 && p3<DECK;p3++) resetBasisCell(p3); }
  updateBasisStats(); snapshotLayoutMapping();
  reconcileSuggestion();
}
function updateBasisStats(){ var up=getSelectedIndicesUnique(); byId('basisUpCount').textContent=String(up.length); byId('basisQuadCount').textContent=String(computeQuadsBasic(up)); }
function initBasisTab(){
  basis.pile=byId('basisPile');
  basis.gridL=byId('basis-grid-left');
  basis.gridR=byId('basis-grid-right');
  basis.editing=false;
  showPreBasisGrid();
  basis.pile.innerHTML='';
  updateBasisStats();
  var startBtn = byId('basisStartNew'); if(startBtn){ startBtn.onclick = startNewBasis; }
  var s0 = byId('basisSuggest0'); if(s0){ s0.onclick = suggestZero; }
  var sn = byId('basisSuggestNext'); if(sn){ sn.onclick = suggestNextBasis; }
  var resetBtn = byId('basisResetLayout'); if(resetBtn){ resetBtn.onclick = resetToStandardLayout; }
if(byId('basisSuggest0')) byId('basisSuggest0').disabled = true;
  if(byId('basisSuggestNext')) byId('basisSuggestNext').disabled = true;
}
function refreshBasisEverything(){ if(basis.editing){ buildBasisGrid(); refreshBasisPile(); basisAutoFill(); } else { showPreBasisGrid(); updateBasisStats(); } }
function applyMappingToSelect(useLocked){ if(useLocked===void 0) useLocked=false; var map=(useLocked && basis.lockedPos2val)? basis.lockedPos2val : basis.pos2val; if(!map) return; var half=(DECK===64?32:(DECK===32?16:DECK)); for(var p=0;p<DECK;p++){ var val=map[p]; var card=getCardEl(val); if(!card) continue; var targetGrid=(p<half)? gridL : gridR; targetGrid.appendChild(card.closest('.cell')); } }
function lockPositions(){ clearBasisSuggestMsg();
  snapshotLayoutMapping();
  if(!basis.mappingComplete){ return; }
  basis.lockedPos2val = basis.pos2val.slice(0);
  basis.locked = true;
  applyMappingToSelect(true);
  buildPhiGridIfInit();
  basis.editing=false;
  showPreBasisGrid();
  if(basis.pile) basis.pile.innerHTML='';
  if(byId('basisSuggest0')) byId('basisSuggest0').disabled = true;
  if(byId('basisSuggestNext')) byId('basisSuggestNext').disabled = true;
  updateBasisStats();
  updateDownstreamCounts();
  var m=byId('basisResetMsg'); if(m) m.textContent='Basis locked: layout applied to all tabs.';
}
function resetToStandardLayout(){ clearBasisSuggestMsg();
  var map=[]; for(var i=0;i<DECK;i++) map[i]=i;
  basis.pos2val = map.slice();
  basis.val2pos = map.slice();
  basis.mappingComplete = true;
  basis.lockedPos2val = map.slice();
  basis.locked = true;
  applyMappingToSelect(true);
  basis.editing=false;
  showPreBasisGrid();
  updateBasisStats();
  buildPhiGridIfInit();
  if(basis && basis.pile){ basis.pile.innerHTML=''; }
  var msg = byId('basisResetMsg'); if(msg){ msg.textContent=''; }
}
function makeStaticCard(n){ var cell=document.createElement('div'); cell.className='cell'; var card=document.createElement('div'); card.className='card'; if(isFaceUp(n)) card.classList.add('faceup'); card.dataset.index=n; var front=makeFront(n); var back=document.createElement('div'); back.className='back'; back.textContent='●'; card.appendChild(front); card.appendChild(back); cell.appendChild(card); return cell; }
function currentPositionMap(){ if(basis.locked && basis.lockedPos2val) return basis.lockedPos2val.slice(0); if(basis.mappingComplete && basis.pos2val) return basis.pos2val.slice(0); var m=[]; for(var i=0;i<DECK;i++) m[i]=i; return m; }
function showPreBasisGrid(){ if(!basis.gridL||!basis.gridR) return; var map=currentPositionMap(); basis.gridL.innerHTML=''; basis.gridR.innerHTML=''; var divider=document.querySelector('.bin-divider'); if(DECK===64){ basis.gridL.className='grid c4x8'; basis.gridR.className='grid c4x8'; for(var i=0;i<32;i++) basis.gridL.appendChild(makeStaticCard(map[i])); for(var j=32;j<64;j++) basis.gridR.appendChild(makeStaticCard(map[j])); if(divider) divider.style.display='block'; } else if(DECK===32){ basis.gridL.className='grid c4x4'; basis.gridR.className='grid c4x4'; for(var a=0;a<16;a++) basis.gridL.appendChild(makeStaticCard(map[a])); for(var b=16;b<32;b++) basis.gridR.appendChild(makeStaticCard(map[b])); if(divider) divider.style.display='block'; } else { basis.gridL.className='grid single4x4'; basis.gridR.className='grid single4x4'; for(var c=0;c<16;c++) basis.gridL.appendChild(makeStaticCard(map[c])); if(divider) divider.style.display='none'; } byId('basisGridTitle').textContent='Grid (current positions)'; }
function startNewBasis(){ clearSuggest0Msg(); var _m=byId('basisResetMsg'); if(_m) _m.textContent=''; clearBasisSuggestMsg(); basis.editing=true; buildBasisGrid(); refreshBasisPile(); basisAutoFill(); if(byId('basisSuggest0')) byId('basisSuggest0').disabled = false; if(byId('basisSuggestNext')) byId('basisSuggestNext').disabled = false; }

// Suggestion helpers
function clearSuggested(){ var prev=basis.pile?basis.pile.querySelector('.card.suggested'):null; if(prev) prev.classList.remove('suggested'); }
function highlightSuggested(idx,msgEl,msg){ clearSuggested(); var el=basis.pile?basis.pile.querySelector('.card[data-index="'+idx+'"]'):null; if(el){ el.classList.add('suggested'); if(msgEl) msgEl.textContent = msg||('Suggested card: '+idx); } else { if(msgEl) msgEl.textContent = 'No available card to suggest.'; } }
function getPlacedValuesSet(){ var set={}; var anchors=[0,1,2,4,8,16,32].filter(function(x){return x<DECK;}); for(var i=0;i<anchors.length;i++){ var v=readBasisValue(anchors[i]); if(v!=null) set[v]=1; } return set; }
function findNextFromPile(excludeSet){ if(!basis.pile) return null; var cards=Array.prototype.slice.call(basis.pile.querySelectorAll('.card[data-index]'));
  for(var i=0;i<cards.length;i++){ var idx=+cards[i].dataset.index; if(!excludeSet[idx]) return idx; }
  return null;
}

// ===== Improved Suggestion Logic (quads-aware) =====
function getFaceUpArray(){ return getSelectedIndices(); }
function getFaceUpSet(){ var arr=getFaceUpArray(); var s={}; for(var i=0;i<arr.length;i++) s[arr[i]]=1; return s; }
function pileCandidateArray(excludeSet){ if(!basis.pile) return []; var els=Array.prototype.slice.call(basis.pile.querySelectorAll('.card[data-index]')); var out=[]; for(var i=0;i<els.length;i++){ var v=+els[i].dataset.index; if(!excludeSet || !excludeSet[v]) out.push(v); } return out; }
function countQuadsInSubset(arr){ return computeQuadsBasic(arr.slice()); }
function countQuadsForCard(v, Uarr, Uset){ var cnt=0; for(var i=0;i<Uarr.length;i++){ var b=Uarr[i]; if(b===v) continue; for(var j=i+1;j<Uarr.length;j++){ var c=Uarr[j]; if(c===v) continue; var d=(v^b^c); if(d in Uset && d>c && d!==v && d!==b && d!==c && d<DECK) cnt++; } } return cnt; }
function countQuadsForPair(a,b,Uarr,Uset){ if(a==null||b==null) return 0; var cnt=0; for(var i=0;i<Uarr.length;i++){ var c=Uarr[i]; if(c===a||c===b) continue; var d=(a^b^c); if(d in Uset && d>c && d!==a && d!==b && d!==c && d<DECK) cnt++; } return cnt; }
function spanFrom(values){ // generate XOR-closure of values (excluding 0)
  var basis=values.filter(function(x){return typeof x==='number';}); var span=[0]; for(var i=0;i<basis.length;i++){ var v=basis[i]; var add=[]; for(var j=0;j<span.length;j++) add.push(span[j]^v); span=span.concat(add); }
  var seen={}, out=[]; for(var k=0;k<span.length;k++){ var val=span[k]; if(val!==0 && val<DECK && !seen[val]){ seen[val]=1; out.push(val); } } return out; }
function placedBasisValues(){ var anchors=[0,1,2,4,8,16,32].filter(function(x){return x<DECK;}); var vals=[]; for(var i=0;i<anchors.length;i++){ var v=readBasisValue(anchors[i]); if(v!=null) vals.push(v); } return vals; }


// --- Helper: clear basis suggestion messages ---
function clearBasisSuggestMsg(){
  var m = byId('basisSuggestMsg');
  if(m) m.textContent = '';
  var m0 = byId('basisSuggest0Msg');
  if(m0) m0.textContent = '';
  var mN = byId('basisSuggestNextMsg');
  if(mN) mN.textContent = '';
}
// --- One-shot message clear on next click after a drop ---
var _basisMsgClearScheduled = false;
function scheduleClearBasisMsgOnNextClick(){
  if(_basisMsgClearScheduled) return;
  _basisMsgClearScheduled = true;
  var handler = function(){
    clearBasisSuggestMsg();
    _basisMsgClearScheduled = false;
    document.removeEventListener('click', handler, true);
  };
  // Use capture so we clear before most UI handlers; emulate {once:true} for broad support
  document.addEventListener('click', handler, true);
}


// Clear the Suggest 0 message
function clearSuggest0Msg(){
  var m = byId('basisSuggest0Msg'); if(m){ m.textContent=''; }
}
function suggestZero(){
  if(!basis.editing){ var m=byId('basisSuggest0Msg'); if(m) m.textContent='Click "Choose new basis" first.'; return; }
  var v0=readBasisValue(0); var msgEl=byId('basisSuggest0Msg'); if(v0!=null){ clearSuggested(); if(msgEl) msgEl.textContent='0 already placed.'; return; }
  var Uarr=getFaceUpArray(); var Uset=getFaceUpSet();
  var exclude=getPlacedValuesSet();
  var candidates=pileCandidateArray(exclude);
  if(candidates.length===0){ highlightSuggested(null,msgEl,'No available card to suggest.'); return; }
  var best=null, bestScore=-1;
  for(var i=0;i<candidates.length;i++){
    var x=candidates[i]; var s=countQuadsForCard(x,Uarr,Uset);
    if(s>bestScore || (s===bestScore && x<best)) { bestScore=s; best=x; }
  }
  highlightSuggested(best, msgEl, best!=null ? ('In ' + bestScore + ' quads') : null);
}

function suggestNextBasis(){
  clearSuggest0Msg(); if(!basis.editing){ var m=byId('basisSuggestNextMsg'); if(m) m.textContent='Click "Choose new basis" first.'; return; }
  var anchors=[1,2,4,8,16,32].filter(function(x){return x<DECK;}); var next=null; for(var i=0;i<anchors.length;i++){ if(readBasisValue(anchors[i])==null){ next=anchors[i]; break; } }
  var msgEl=byId('basisSuggestNextMsg'); if(next==null){ if(msgEl) msgEl.textContent='All basis positions are filled.'; return; }
  var exclude=getPlacedValuesSet(); var candidates=pileCandidateArray(exclude); if(candidates.length===0){ highlightSuggested(null,msgEl,'No available card to suggest.'); return; }
  var Uarr=getFaceUpArray(); var Uset=getFaceUpSet();
  var best=null, bestScore=-1;
  var v0=readBasisValue(0);
  if(next===1 && v0!=null){
    // choose x maximizing quads that include both v0 and x
    for(var k=0;k<candidates.length;k++){
      var x=candidates[k]; var s=countQuadsForPair(v0,x,Uarr,Uset);
      if(s>bestScore || (s===bestScore && x<best)) { bestScore=s; best=x; }
    }
    highlightSuggested(best, msgEl, best!=null ? ('makes a pair that is in ' + bestScore + ' quads') : null);

    return;
  }
  // remaining positions: maximize additional face-up *cards* inside AFFINE odd-span(placed ∪ {x})
  var placed = placedBasisValuesAffine();
  var currentSpanArr = oddSpanFrom(placed);
  // build set for membership checks && counting
  var spanSet = {}; for (var i=0;i<currentSpanArr.length;i++) spanSet[currentSpanArr[i]] = 1;
  // count face-up cards currently in span
  var baseCount = 0; for (var k in Uset) if (Uset.hasOwnProperty(k) && spanSet[k]) baseCount++;
  for (var t=0; t<candidates.length; t++){
    var x = candidates[t];
    // Skip candidates already in the current affine span — they won't expand it
    if (spanSet[x]) continue;
    var newSpanArr = oddSpanFrom(placed.concat([x]));
    var newSet = {}; for (var j=0;j<newSpanArr.length;j++) newSet[newSpanArr[j]] = 1;
    // count face-up cards in new span
    var newCount = 0; for (var k2 in Uset) if (Uset.hasOwnProperty(k2) && newSet[k2]) newCount++;
    var gain = newCount - baseCount;  // additional cards in span
    if (gain > bestScore || (gain === bestScore && x < best)) { bestScore = gain; best = x; }
  }
  // message simplified to reflect additional cards in the span
  highlightSuggested(best, msgEl, best!=null ? ('will position ' + bestScore + ' cards.') : null);


}

function reconcileSuggestion(){ var s=basis.pile?basis.pile.querySelector('.card.suggested'):null; if(!s) return; var idx=+s.dataset.index; var stillInPile = !!(basis.pile.querySelector('.card[data-index="'+idx+'"]')); if(!stillInPile) s.classList.remove('suggested'); }


// --- Affine span helpers (odd-subset sums over basis including position 0) ---
function placedBasisValuesAffine(){
  // Include position 0 as an affine offset/basis element when present
  var anchors=[0,1,2,4,8,16,32].filter(function(x){return x<DECK;});
  var vals=[];
  for(var i=0;i<anchors.length;i++){
    var v=readBasisValue(anchors[i]);
    if(v!=null) vals.push(v);
  }
  return vals;
}

// Build XORs of all subsets of `values` with ODD cardinality (affine view)
// Returns a de-duplicated array in [1, DECK-1] (excludes 0) clipped to current DECK
function oddSpanFrom(values){
  var deckMax = DECK; // current deck constraint
  var even = [0];           // XORs of even-sized subsets (start with empty subset)
  var odd  = [];            // XORs of odd-sized subsets
  for(var i=0;i<values.length;i++){
    var v = values[i] & ((DECK===64)?63:(DECK===32?31:15)); // mask to deck size
    // compute new lists
    var newEven = even.slice();
    for(var j=0;j<odd.length;j++) newEven.push(odd[j]^v);
    var newOdd = odd.slice();
    for(var j2=0;j2<even.length;j2++) newOdd.push(even[j2]^v);
    even = newEven;
    odd = newOdd;
  }
  // Deduplicate, drop 0, and clip to deck
  var seen={}, out=[];
  for(var k=0;k<odd.length;k++){
    var val = odd[k];
    if(val!==0 && val<deckMax && !seen[val]){ seen[val]=1; out.push(val); }
  }
  return out;
}
// ===== Phi Map =====
var phi={ gridL:null, gridR:null, part:null, initialized:false, flowActive:false, selA:null, selB:null, lastPhi:null, quadsBefore:0, quadsAfter:0 };
function buildPhiGridIfInit(){ if(phi.initialized) buildPhiGrid(); }
function makePhiCard(n){ var cell=document.createElement('div'); cell.className='cell phiCell'; var card=document.createElement('div'); card.className='card'+(isFaceUp(n)?' faceup':''); card.dataset.index=n; card.appendChild(makeFront(n)); var back=document.createElement('div'); back.className='back'; back.textContent='●'; card.appendChild(back); cell.appendChild(card); return cell; }
function updatePhiQuadsDisplay(){ var beforeEl = byId('phiQuadBefore'); var afterEl = byId('phiQuadAfter'); if(beforeEl) beforeEl.textContent = String(phi.quadsBefore || 0); if(afterEl) afterEl.textContent = (phi.lastPhi ? String(phi.quadsAfter || 0) : ''); }
function buildPhiGrid(){ if(!phi.gridL||!phi.gridR) return; phi.gridL.innerHTML=''; phi.gridR.innerHTML=''; if(!phi.lastPhi && !phi.flowActive){ phi.quadsBefore = String(computeQuadsBasic(getSelectedIndices())); }
  var map=currentPositionMap(); var dividerEls=document.querySelectorAll('.bin-divider'); var divider=dividerEls.length>1?dividerEls[1]:dividerEls[0]; var leftCount=(DECK===64?32:(DECK===32?16:DECK)); var gridClass=(DECK===64?'grid c4x8':(DECK===32?'grid c4x4':'grid single4x4')); phi.gridL.className=gridClass; phi.gridR.className=gridClass; phi.part = phi.part || (function(){ var sel=byId('phiPartition'); var mode; if(DECK===16){ mode='rowsdbl'; if(sel) sel.value='rowsdbl'; } else { mode = sel ? sel.value : 'lr'; } return buildPartition(mode); })(); for(var p=0;p<DECK;p++){ var v=map[p]; var cell=makePhiCard(v); cell.dataset.pos=String(p); if(phi.part && phi.part[p]==='A'){ cell.classList.add('phiA'); } else if(phi.part && phi.part[p]==='B'){ cell.classList.add('phiB'); } var target=(p<leftCount)?phi.gridL:phi.gridR; target.appendChild(cell); }
  if(divider) divider.style.display=(DECK===16?'none':'block'); updatePhiQuadsDisplay(); enhancePhiGrid(); reapplySelectedAB(); updateAHighlights(); }
function initPhiTab(){ phi.gridL = byId('phi-grid-left'); phi.gridR = byId('phi-grid-right'); updatePartitionDisables(); var sel = byId('phiPartition'); var mode; if(DECK===16){ mode='rowsdbl'; if(sel) sel.value='rowsdbl'; } else { mode = sel ? sel.value : 'lr'; } phi.part = buildPartition(mode); buildPhiGrid(); if(sel){ sel.addEventListener('change', function(){ phi.part = buildPartition(sel.value); buildPhiGrid(); resetFlowUI(); clearPhiUndo(); }); } byId('phiStart').onclick=startFlow; byId('phiApply').onclick=applyFlow; byId('phiClearSel').onclick=function(){ resetFlowUI(); buildPhiGrid(); }; byId('phiUndo').onclick=undoPhiMap; phi.initialized = true; }
function reapplySelectedAB(){ if(phi.selA==null && phi.selB==null) return; function mark(index, cls){ if(index==null) return; var el=document.querySelector('#phi-grid-left .card[data-index="'+index+'"], #phi-grid-right .card[data-index="'+index+'"]'); if(el){ var cell=el.closest('.cell'); if(cell) cell.classList.add(cls); } } mark(phi.selB,'phiSelectedB'); mark(phi.selA,'phiSelectedA'); }
function updatePartitionDisables(){ var sel=byId('phiPartition'); if(!sel) return; for(var i=0;i<sel.options.length;i++) sel.options[i].disabled=false; if(DECK===32){ var optTB=sel.querySelector('option[value="tb"]'); if(optTB) optTB.disabled=true; if(sel.value==='tb') sel.value='lr'; } if(DECK===16){ var optTB2=sel.querySelector('option[value="tb"]'); var optLR=sel.querySelector('option[value="lr"]'); if(optTB2) optTB2.disabled=true; if(optLR) optLR.disabled=true; if(sel.value==='tb'||sel.value==='lr') sel.value='rowsdbl'; } }
function posRC(p){ var cols=4; var half=(DECK===64?32:(DECK===32?16:DECK)); var rowsPerSide=(DECK===64?8:4); var local=(DECK===16? p : (p<half? p : p-half)); var row=Math.floor(local/cols); var col=local%cols; return {row:row,col:col,rowsPerSide:rowsPerSide,side:(DECK===16?'L':(p<half?'L':'R'))}; }
function buildPartition(mode){ var part=Array(DECK).fill(null); for(var p=0;p<DECK;p++){ var rc=posRC(p); var inA=false; if(mode==='lr'){ inA=(rc.side==='L'); } else if(mode==='tb'){ inA=(rc.row < rc.rowsPerSide/2); } else if(mode==='rowsdbl'){ inA=(Math.floor(rc.row/2)%2===0); } else if(mode==='colsdbl'){ inA=(Math.floor(rc.col/2)%2===0); } else if(mode==='rowsAlt'){ inA=(rc.row%2===0); } else if(mode==='colsAlt'){ inA=(rc.col%2===0); } part[p]=inA?'A':'B'; } return part; }
function enhancePhiGrid(){ var map=currentPositionMap(); var leftCount=(DECK===64?32:(DECK===32?16:DECK)); var cellsL=Array.prototype.slice.call(byId('phi-grid-left').children); var cellsR=Array.prototype.slice.call(byId('phi-grid-right').children); function attach(cell,p){ var v=(p<map.length)? map[p]:null; var cardEl=cell.querySelector('.card'); var up=cardEl && cardEl.classList.contains('faceup'); cell.onclick=function(){ if(!phi.part) return; var isA=(phi.part[p]==='A'); var isB=!isA; if(phi.flowActive){ if(phi.selB==null){ if(isB && up){ phi.selB=v; cell.classList.add('phiSelectedB'); setPhiInfo('b = '+v+' ('+pad6(v)+'). Now pick a (face-down) from gold A.'); updateAHighlights(); } else { setPhiInfo('b must be FACE-UP in purple B.'); } } else if(phi.selA==null){ var up2=cardEl && cardEl.classList.contains('faceup'); if(isA && !up2){ phi.selA=v; cell.classList.add('phiSelectedA'); byId('phiApply').disabled=false; setPhiInfo('a = '+v+' ('+pad6(v)+'). Click Apply.'); updateAHighlights(); } else { setPhiInfo('a must be FACE-DOWN in gold A.'); } } } }; }
  for(var i=0;i<cellsL.length;i++) attach(cellsL[i], i);
  for(var j=0;j<cellsR.length;j++) attach(cellsR[j], leftCount+j);
}
function setPhiInfo(msg){ var el=byId('phiInfo'); if(el){ el.innerHTML=msg; } }
function updateAHighlights(){ clearATargetShadows(); if(phi.selA==null || phi.selB==null) return; var mask=(DECK===64?63:(DECK===32?31:15)); var map=currentPositionMap(); var leftCount=(DECK===64?32:(DECK===32?16:DECK)); for(var p=0;p<DECK;p++){ if(!phi.part || phi.part[p]!=="B") continue; var v=map[p]; var phiCell = (p<leftCount) ? byId('phi-grid-left').children[p] : byId('phi-grid-right').children[p-leftCount]; if(!phiCell) continue; var phiCard = phiCell.querySelector('.card'); var isUp = !!(phiCard && phiCard.classList.contains('faceup')); if(!isUp) continue; var t=(v ^ phi.selA ^ phi.selB) & mask; var targetCard = document.querySelector('#phi-grid-left .card[data-index="'+t+'"], #phi-grid-right .card[data-index="'+t+'"]'); if(targetCard){ targetCard.classList.add('a-shadow'); } } }
function clearATargetShadows(){ var cards=document.querySelectorAll('#phi-grid-left .card, #phi-grid-right .card'); for(var i=0;i<cards.length;i++){ cards[i].classList.remove('a-shadow'); } }
function startFlow(){ phi.flowActive=true; phi.selA=null; phi.selB=null; byId('phiApply').disabled=true; phi.quadsBefore = computeQuadsBasic(getSelectedIndices()); updatePhiQuadsDisplay(); setPhiInfo('Flow active: pick b (face-up, purple B), then a (face-down, gold A).'); updateAHighlights(); }
function resetFlowUI(){ phi.flowActive=false; phi.selA=null; phi.selB=null; byId('phiApply').disabled=true; clearATargetShadows(); clearSelections(); setPhiInfo('Pick a face-up card for <b>b</b> from a purple (B) zone, then a face-down card for <b>a</b> from a gold (A) zone.'); }
function clearSelections(){ var cells=document.querySelectorAll('#phi-grid-left .cell, #phi-grid-right .cell'); for(var i=0;i<cells.length;i++){ cells[i].classList.remove('phiSelectedA','phiSelectedB'); } }
function clearPhiUndo(){ phi.lastPhi=null; var u=byId('phiUndo'); if(u) u.disabled=true; }
function updateUndoState(){ var u=byId('phiUndo'); if(u) u.disabled=!phi.lastPhi; }
function applyFlow(){
  if(phi.selA==null || phi.selB==null) return;
  var a=phi.selA, b=phi.selB;
  var mask=(DECK===64?63:(DECK===32?31:15));
  var swaps=[];
  var map=currentPositionMap();
  for(var p=0;p<DECK;p++){
    if(phi.part[p]==='B'){
      var v=map[p];
      if(isFaceUp(v)){
        var t=(v ^ a ^ b) & mask;
        if(!isFaceUp(t)){
          setFaceUp(v,false);
          setFaceUp(t,true);
          swaps.push({from:v,to:t});
        }
      }
    }
  }
  phi.lastPhi={a:a,b:b,swaps:swaps,deck:DECK};
  updateUndoState();
  updateUpCount();
  phi.quadsAfter = computeQuadsBasic(getSelectedIndices());
  updatePhiQuadsDisplay();
  setPhiInfo('<b>Applied φ-map</b> with <b>b='+b+'</b>, <b>a='+a+'</b>.');
  resetFlowUI();
  buildPhiGrid();
}
function undoPhiMap(){ if(!phi.lastPhi) return; if(phi.lastPhi.deck!==DECK){ setPhiInfo('Cannot undo: deck size changed.'); clearPhiUndo(); return; } var s=phi.lastPhi.swaps||[]; for(var i=0;i<s.length;i++){ var f=s[i].from, t=s[i].to; if(isFaceUp(t)) setFaceUp(t,false); if(!isFaceUp(f)) setFaceUp(f,true); } updateUpCount(); phi.quadsAfter = computeQuadsBasic(getSelectedIndices()); updatePhiQuadsDisplay(); setPhiInfo('Undid last φ-map.'); clearPhiUndo(); buildPhiGrid(); }

// ---- Lightweight sanity checks (non-blocking) ----
(function(){ try{
  console.assert(computeQuadsBasic([])===0, '0 quads for empty');
  console.assert(computeQuadsBasic([0,1,2,3])===1, 'one quad in 0,1,2,3');
  // Extra tests
  console.assert(computeQuadsBasic([0,1,2])===0, 'no quad in 0,1,2');
  console.assert(computeQuadsBasic([0,1,2,3,4])===1, 'still one quad when adding 4');
  console.assert(computeQuadsBasic([0,1,2,3,3,3])===1, 'duplicates should be ignored');
  // Span sanity checks
  console.assert(JSON.stringify(spanFrom([1]))==JSON.stringify([1]), 'span([1]) == [1]');
  var s12 = spanFrom([1,2]).sort(function(a,b){return a-b;});
  console.assert(JSON.stringify(s12)==JSON.stringify([1,2,3]), 'span([1,2]) == [1,2,3]');
} catch(e){ console.warn('Sanity tests failed', e); } })();
</script>
</body>
</html>
